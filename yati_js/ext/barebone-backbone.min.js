(function(){"use strict";var e,t,i,s,r,n,o,a,c,u,l,h=this;"undefined"!=typeof exports?(e=require("underscore"),t=require("backbone"),"undefined"!=typeof module&&module.exports&&(module.exports=t),exports=t):(e=h._,t=h.Backbone),i=t.Model,s=t.Collection,r=i.prototype,n=s.prototype,t.Associations={VERSION:"0.5.5"};var p=function(){return u},d=function(t){(!e.isString(t)||1>e.size(t))&&(t="."),u=t,a=RegExp("[\\"+u+"\\[\\]]+","g"),c=RegExp("[^\\"+u+"\\[\\]]+","g")};try{Object.defineProperty(t.Associations,"SEPARATOR",{enumerable:!0,get:p,set:d})}catch(f){}t.Associations.Many=t.Many="Many",t.Associations.One=t.One="One",t.Associations.Self=t.Self="Self",t.Associations.SEPARATOR=".",t.Associations.getSeparator=p,t.Associations.setSeparator=d,t.Associations.EVENTS_BUBBLE=!0,t.Associations.EVENTS_WILDCARD=!0,t.Associations.EVENTS_NC=!0,d(),o=t.AssociatedModel=t.Associations.AssociatedModel=i.extend({relations:void 0,_proxyCalls:void 0,get:function(e){var t=r.get.call(this,e);return t?t:this._getAttr.apply(this,arguments)},set:function(t,i,s){var r,n;return e.isObject(t)||null==t?(r=t,s=i):(r={},r[t]=i),n=this._set(r,s),this._processPendingEvents(),n},_set:function(t,i){var s,r,n,c,u=this;if(!t)return this;for(s in t)if(r||(r={}),s.match(a)){var l=g(s),h=e.initial(l),p=l[l.length-1],d=this.get(h);d instanceof o&&(c=r[d.cid]||(r[d.cid]={model:d,data:{}}),c.data[p]=t[s])}else c=r[this.cid]||(r[this.cid]={model:this,data:{}}),c.data[s]=t[s];if(r)for(n in r)c=r[n],this._setAttr.call(c.model,c.data,i)||(u=!1);else u=this._setAttr.call(this,t,i);return u},_setAttr:function(n,a){var c;if(a||(a={}),a.unset)for(c in n)n[c]=void 0;return this.parents=this.parents||[],this.relations&&e.each(this.relations,function(r){var c,u,l,h,p=r.key,d=r.relatedModel,f=r.collectionType,g=r.map,m=this.attributes[p],_=m&&m.idAttribute,v=!1;if(!d||d.prototype instanceof i||(d=e.isFunction(d)?d.call(this,r,n):d),d&&e.isString(d)&&(d=d===t.Self?this.constructor:y(d)),f&&e.isString(f)&&(f=y(f)),g&&e.isString(g)&&(g=y(g)),u=r.options?e.extend({},r.options,a):a,!d&&!f)throw Error("specify either a relatedModel or collectionType");if(n[p]){if(c=e.result(n,p),c=g?g.call(this,c,f?f:d):c,r.type===t.Many){if(f&&!f.prototype instanceof s)throw Error("collectionType must inherit from Backbone.Collection");m?(m._deferEvents=!0,m[u.reset?"reset":"set"](c instanceof s?c.models:c,u),l=m):(v=!0,c instanceof s?l=c:(l=f?new f:this._createCollection(d),l[u.reset?"reset":"set"](c,u)))}else{if(r.type!==t.One)throw Error("type attribute must be specified and have the values Backbone.One or Backbone.Many");if(!d)throw Error("specify a relatedModel for Backbone.One type");if(!(d.prototype instanceof t.AssociatedModel))throw Error("specify an AssociatedModel for Backbone.One type");l=c instanceof o?c:new d(c,u),m&&l.attributes[_]&&m.attributes[_]===l.attributes[_]?(m._deferEvents=!0,m._set(c instanceof o?c.attributes:c,u),l=m):v=!0}n[p]=l,h=l,(v||h&&!h._proxyCallback)&&(h._proxyCallback=function(){return t.Associations.EVENTS_BUBBLE&&this._bubbleEvent.call(this,p,h,arguments)},h.on("all",h._proxyCallback,this))}if(n.hasOwnProperty(p)){var P=n[p],b=this.attributes[p];P?(P.parents=P.parents||[],-1==e.indexOf(P.parents,this)&&P.parents.push(this)):b&&b.parents.length>0&&(b.parents=e.difference(b.parents,[this]),b._proxyCallback&&b.off("all",b._proxyCallback,this))}},this),r.set.call(this,n,a)},_bubbleEvent:function(e,r,n){var o,a,c=n,h=c[0].split(":"),p=h[0],d="nested-change"==c[0],f="change"===p,g=c[1],y=-1,m=r._proxyCalls,_=h[1];if(!d){if(t.Associations.EVENTS_WILDCARD&&/\[\*\]/g.test(_))return this;if(r instanceof s&&(f||_)&&(y=r.indexOf(l||g)),this instanceof i&&(l=this),_=e+(-1!==y&&(f||_)?"["+y+"]":"")+(_?u+_:""),t.Associations.EVENTS_WILDCARD&&(a=_.replace(/\[\d+\]/g,"[*]")),o=[],o.push.apply(o,c),o[0]=p+":"+_,t.Associations.EVENTS_WILDCARD&&_!==a&&(o[0]=o[0]+" "+p+":"+a),m=r._proxyCalls=m||{},this._isEventAvailable.call(this,m,_))return this;if(m[_]=!0,f&&(this._previousAttributes[e]=r._previousAttributes,this.changed[e]=r),this.trigger.apply(this,o),t.Associations.EVENTS_NC&&f&&this.get(_)!=c[2]){var v=["nested-change",_,c[1]];c[2]&&v.push(c[2]),this.trigger.apply(this,v)}return m&&_&&delete m[_],l=void 0,this}},_isEventAvailable:function(t,i){return e.find(t,function(e,t){return-1!==i.indexOf(t,i.length-t.length)})},_createCollection:function(t){var i,r=t;if(e.isString(r)&&(r=y(r)),!(r&&r.prototype instanceof o||e.isFunction(r)))throw Error("type must inherit from Backbone.AssociatedModel");return i=new s,i.model=r,i},_processPendingEvents:function(){this._processedEvents||(this._processedEvents=!0,this._deferEvents=!1,e.each(this._pendingEvents,function(e){e.c.trigger.apply(e.c,e.a)}),this._pendingEvents=[],e.each(this.relations,function(e){var t=this.attributes[e.key];t&&t._processPendingEvents()},this),delete this._processedEvents)},trigger:function(){this._deferEvents?(this._pendingEvents=this._pendingEvents||[],this._pendingEvents.push({c:this,a:arguments})):r.trigger.apply(this,arguments)},toJSON:function(t){var i,s={};return s[this.idAttribute]=this.id,this.visited||(this.visited=!0,s=r.toJSON.apply(this,arguments),this.relations&&e.each(this.relations,function(r){var n=r.key,o=r.remoteKey,a=this.attributes[n],c=!r.isTransient;delete s[n],c&&(i=a&&a.toJSON?a.toJSON(t):a,s[o||n]=e.isArray(i)?e.compact(i):i)},this),delete this.visited),s},clone:function(){return new this.constructor(this.toJSON())},cleanup:function(){e.each(this.relations,function(t){var i=this.attributes[t.key];i&&(i.parents=e.difference(i.parents,[this]))},this),this.off()},_getAttr:function(t){var i,r,n=this,o=g(t);if(!(1>e.size(o))){for(r=0;o.length>r&&(i=o[r],n);r++)n=n instanceof s?isNaN(i)?void 0:n.at(i):n.attributes[i];return n}}});var g=function(t){return""===t?[""]:e.isString(t)?t.match(c):t||[]},y=function(t){return e.reduce(t.split(u),function(e,t){return e[t]},h)},m=function(t,i,s){var r,n;return e.find(t,function(t){return r=e.find(t.relations,function(e){return t.get(e.key)===i},this),r?(n=t,!0):void 0},this),r&&r.map?r.map.call(n,s,i):s},_={};e.each(["set","remove","reset"],function(e){_[e]=s.prototype[e],n[e]=function(t){return this.model.prototype instanceof o&&this.parents&&(arguments[0]=m(this.parents,this,t)),_[e].apply(this,arguments)}}),_.trigger=n.trigger,n.trigger=function(){this._deferEvents?(this._pendingEvents=this._pendingEvents||[],this._pendingEvents.push({c:this,a:arguments})):_.trigger.apply(this,arguments)},n._processPendingEvents=o.prototype._processPendingEvents}).call(this),function(e,t){"use strict";if(e===void 0&&(e={}),i===void 0)var i={log:function(){},error:function(){},trace:function(){}};e.config=_(e.config||{}).extend({urlRoot:"/site/api/",queryParams:{},queryParamsMap:{serializer:"serializer",pageSize:"page_size",page:"page",ordering:"order"},responseParamsMap:{count:"count",results:"results"},defaultPageSize:50}),e.QueryParams=t.Model.extend({defaults:{page:1},initialize:function(e,t){_(this).bindAll("on_change"),t||(t={}),this.parent=t.parent,this.on("change",this.on_change)},on_change:function(){var e=this.changedAttributes();e&&1===_(e).keys().length&&"count"in e||this.parent&&this.parent.fetch()},getForQuery:function(e){return e?_(this.attributes).pick("serializer"):_(this.attributes).omit("count")},getPages:function(){return Math.ceil(this.get("count")/this.get("pageSize")||e.config.defaultPageSize)},nextPage:function(){return this.set("page",this.get("page")+1),this},prevPage:function(){return this.set("page",this.get("page")-1),this}},{serialize:function(t){var i={};return _(t).each(function(t,s){e.config.queryParamsMap[s]&&(s=e.config.queryParamsMap[s]),i[s]=t===!0?"True":t===!1?"False":t}),i}}),e.TQueried={initQueryParams:function(e){return e||(e={}),this.setQueryParams(e.queryParams||{},{fetch:!1}),this},setQueryParams:function(t,i){var s;return"object"!=typeof t?(s={},s[t]=i,i=null):s=t,i||(i={}),this.queryParams&&e.QueryParams.prototype.isPrototypeOf(this.queryParams)||(this.queryParams=new e.QueryParams(this.queryParams||{},{parent:this})),this.queryParams.set(s,{silent:i.fetch===!1||i.silent===!0}),this},parse:function(i){if(t.Collection.prototype.isPrototypeOf(this)){if(_(i).isArray())return i;var s=i[e.config.responseParamsMap.count];return s!==void 0&&this.setQueryParams({count:s}),i[e.config.responseParamsMap.results]}return i}},e.Model=("AssociatedModel"in t?t.AssociatedModel:t.Model).extend(_({}).extend(e.TQueried,{modelName:"model",constructor:function(e,i){("AssociatedModel"in t?t.AssociatedModel:t.Model).apply(this,[e,i]),this.initQueryParams(i)},onceSet:function(e,t,i){return this.has(e)?t.apply(i,[this,this.get(e)]):this.once("change:"+e,t,i),this}})),e.Collection=t.Collection.extend(_({}).extend(e.TQueried,{constructor:function(e,i){t.Collection.apply(this,[e,i]),this.initQueryParams(i)}}));var s=t.sync;e.sync_api=function(i,r,n){var o=_({}).extend(_(e.config).result("queryParams")),a=t.Model.prototype.isPrototypeOf(r);return a?r.modelName:r.model&&r.model.modelName,r.queryParams?_(o).extend(r.queryParams.getForQuery()):a&&r.collection&&r.collection.queryParams&&_(o).extend(r.collection.queryParams.getForQuery(!0)),_(o).extend(n.queryParams||{}),n.url=(n.url||r.urlRoot||r.model&&r.model.urlRoot||r.collection&&r.collection.urlRoot)+(a&&r.has("id")?r.get("id"):""),window.params=[n.url+"",r.url,r.urlRoot,r.model&&r.model.prototype.urlRoot],n.url+="?"+$.param(e.QueryParams.serialize(o)),s(i,r,n)},t.sync=e.sync_api}(window.barebone===void 0?window.barebone={}:window.barebone,Backbone,jQuery);