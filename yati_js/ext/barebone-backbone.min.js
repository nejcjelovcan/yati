(function(){var f,h,q,l,p,o,s;"undefined"!=typeof require?(f=require("underscore"),h=require("backbone"),exports=module.exports=h):(f=this._,h=this.Backbone),q=h.Model,l=h.Collection,p=q.prototype,s=/[\.\[\]]+/g,h.Many="Many",h.One="One",o=h.AssociatedModel=q.extend({relations:void 0,_proxyCalls:void 0,get:function(e){var t=p.get.call(this,e);return t?t:this.getAttr.apply(this,arguments)},set:function(e,t,i){var n,a,u,c,l=this;if(f.isObject(e)||null==e?(n=e,i=t):(n={},n[e]=t),!n)return this;for(a in n)u||(u={}),a.match(s)?(e=r(a),t=f.initial(e),e=e[e.length-1],t=this.get(t),t instanceof o&&(t=u[t.cid]||(u[t.cid]={model:t,data:{}}),t.data[e]=n[a])):(t=u[this.cid]||(u[this.cid]={model:this,data:{}}),t.data[a]=n[a]);if(!u)return this.setAttr.call(this,n,i);for(c in u)t=u[c],this.setAttr.call(t.model,t.data,i)||(l=!1);return l},setAttr:function(b,a){var d;if(a||(a={}),a.unset)for(d in b)b[d]=void 0;return this.relations&&f.each(this.relations,function(c){var d=c.key,e=c.relatedModel,i=c.collectionType,g,j,n,m;if(b[d]){if(g=f.result(b,d),e&&f.isString(e)&&(e=eval(e)),i&&f.isString(i)&&(i=eval(i)),j=c.options?f.extend({},c.options,a):a,c.type===h.Many){if(i&&!i.prototype instanceof l)throw Error("collectionType must inherit from Backbone.Collection");g instanceof l?n=g:(n=i?new i:this._createCollection(e),n.add(g,j)),b[d]=n}else c.type===h.One&&e&&(n=g instanceof o?g:new e(g),b[d]=n);(m=n)&&!m._proxyCallback&&(m._proxyCallback=function(){return this._bubbleEvent.call(this,d,m,arguments)},m.on("all",m._proxyCallback,this))}},this),p.set.call(this,b,a)},_bubbleEvent:function(e,t,i){var n,a=i[0].split(":"),s=a[0],u=i[1],c=-1,h=t._proxyCalls;if(f.size(a)>1&&(n=a[1]),t instanceof l&&"change"===s&&u){var d=r(n),p=f.initial(d);(a=t.find(function(e){if(u===e)return!0;if(e){var t=e.get(p);return(t instanceof o||t instanceof l)&&u===t?!0:(t=e.get(d),(t instanceof o||t instanceof l)&&u===t)}return!1}))&&(c=t.indexOf(a))}if(n=e+(-1!==c?"["+c+"]":"")+(n?"."+n:""),i[0]=s+":"+n,h){if(c=f.find(h,function(e,t){return-1!==n.indexOf(t,n.length-t.length)}))return this}else h=t._proxyCalls={};return h[n]=!0,"change"===s&&(this._previousAttributes[e]=t._previousAttributes,this.changed[e]=t),this.trigger.apply(this,i),n&&h&&delete h[n],this},_createCollection:function(b){var a=b;if(f.isString(a)&&(a=eval(a)),!(a&&a.prototype instanceof o))throw Error("type must inherit from Backbone.AssociatedModel");return b=new l,b.model=a,b},toJSON:function(e){var t,r;return this.visited||(this.visited=!0,t=p.toJSON.apply(this,arguments),this.relations&&f.each(this.relations,function(i){var n=this.attributes[i.key];n&&(r=n.toJSON(e),t[i.key]=f.isArray(r)?f.compact(r):r)},this),delete this.visited),t},clone:function(){return new this.constructor(this.toJSON())},getAttr:function(e){var t,i,n=this,e=r(e);if(!(1>f.size(e))){for(i=0;e.length>i&&(t=e[i],n);i++)n=n instanceof l&&!isNaN(t)?n.at(t):n.attributes[t];return n}}});var t=/[^\.\[\]]+/g,r=function(e){return""===e?[""]:f.isString(e)?e.match(t):e||[]}}).call(this),function(e,t){"use strict";if(e===void 0&&(e={}),r===void 0)var r={log:function(){},error:function(){},trace:function(){}};e.config=_(e.config||{}).extend({urlRoot:"/site/api/",queryParams:{},queryParamsMap:{serializer:"serializer",pageSize:"page_size",page:"page",ordering:"order"},responseParamsMap:{count:"count",results:"results"},defaultPageSize:50}),e.QueryParams=t.Model.extend({defaults:{page:1},initialize:function(e,t){_(this).bindAll("on_change"),t||(t={}),this.parent=t.parent,this.on("change",this.on_change)},on_change:function(){var e=this.changedAttributes();e&&1===_(e).keys().length&&"count"in e||this.parent&&this.parent.fetch()},getForQuery:function(e){return e?_(this.attributes).pick("serializer"):_(this.attributes).omit("count")},getPages:function(){return Math.ceil(this.get("count")/this.get("pageSize")||e.config.defaultPageSize)},nextPage:function(){return this.set("page",this.get("page")+1),this},prevPage:function(){return this.set("page",this.get("page")-1),this}},{serialize:function(t){var r={};return _(t).each(function(t,i){e.config.queryParamsMap[i]&&(i=e.config.queryParamsMap[i]),r[i]=t===!0?"True":t===!1?"False":t}),r}}),e.TQueried={initQueryParams:function(e){return e||(e={}),this.setQueryParams(e.queryParams||{},{fetch:!1}),this},setQueryParams:function(t,r){var i;return"object"!=typeof t?(i={},i[t]=r,r=null):i=t,r||(r={}),this.queryParams&&e.QueryParams.prototype.isPrototypeOf(this.queryParams)||(this.queryParams=new e.QueryParams(this.queryParams||{},{parent:this})),this.queryParams.set(i,{silent:r.fetch===!1||r.silent===!0}),this},parse:function(r){if(t.Collection.prototype.isPrototypeOf(this)){if(_(r).isArray())return r;var i=r[e.config.responseParamsMap.count];return i!==void 0&&this.setQueryParams({count:i}),r[e.config.responseParamsMap.results]}return r}},e.Model=("AssociatedModel"in t?t.AssociatedModel:t.Model).extend(_({}).extend(e.TQueried,{modelName:"model",constructor:function(e,r){("AssociatedModel"in t?t.AssociatedModel:t.Model).apply(this,[e,r]),this.initQueryParams(r)},onceSet:function(e,t,r){return this.has(e)?t.apply(r,[this,this.get(e)]):this.once("change:"+e,t,r),this}})),e.Collection=t.Collection.extend(_({}).extend(e.TQueried,{constructor:function(e,r){t.Collection.apply(this,[e,r]),this.initQueryParams(r)}}));var i=t.sync;e.sync_api=function(r,n,o){var a=_({}).extend(_(e.config).result("queryParams")),s=t.Model.prototype.isPrototypeOf(n);return s?n.modelName:n.model&&n.model.modelName,n.queryParams?_(a).extend(n.queryParams.getForQuery()):s&&n.collection&&n.collection.queryParams&&_(a).extend(n.collection.queryParams.getForQuery(!0)),_(a).extend(o.queryParams||{}),o.url=(o.url||n.urlRoot||n.model&&n.model.urlRoot||n.collection&&n.collection.urlRoot)+(s&&n.has("id")?n.get("id"):""),window.params=[o.url+"",n.url,n.urlRoot,n.model&&n.model.prototype.urlRoot],o.url+="?"+$.param(e.QueryParams.serialize(a)),i(r,n,o)},t.sync=e.sync_api}(window.barebone===void 0?window.barebone={}:window.barebone,Backbone,jQuery);